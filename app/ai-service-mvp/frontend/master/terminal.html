<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–¢–µ—Ä–º–∏–Ω–∞–ª –º–∞—Å—Ç–µ—Ä–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .header-status {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        .container {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card-title {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .job-card {
            border-left: 4px solid #2196F3;
        }
        
        .job-card.urgent {
            border-left-color: #f44336;
        }
        
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .job-category {
            font-size: 18px;
            font-weight: 600;
        }
        
        .job-price {
            font-size: 20px;
            font-weight: 700;
            color: #4CAF50;
        }
        
        .job-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .job-info strong {
            color: #333;
        }
        
        .job-address {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin: 12px 0;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .job-address svg {
            flex-shrink: 0;
            color: #2196F3;
        }
        
        .job-instructions {
            background: #fff3e0;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }
        
        .job-instructions-title {
            font-weight: 600;
            color: #e65100;
            margin-bottom: 8px;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
        }
        
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1976D2;
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #388E3C;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-outline {
            background: white;
            color: #666;
            border: 2px solid #ddd;
        }
        
        .btn-outline:hover {
            border-color: #2196F3;
            color: #2196F3;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-assigned {
            background: #e3f2fd;
            color: #1976D2;
        }
        
        .status-accepted {
            background: #fff3e0;
            color: #e65100;
        }
        
        .status-in_transit {
            background: #e8f5e9;
            color: #388E3C;
        }
        
        .status-in_progress {
            background: #fff8e1;
            color: #f9a825;
        }
        
        .status-completed {
            background: #e8f5e9;
            color: #2E7D32;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .stat-item {
            text-align: center;
            padding: 16px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #2196F3;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .payment-section {
            background: #e8f5e9;
            border: 2px solid #4CAF50;
        }
        
        .payment-amount {
            font-size: 36px;
            font-weight: 700;
            color: #2E7D32;
            text-align: center;
            margin: 16px 0;
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 16px 0;
        }
        
        .payment-method {
            padding: 12px 8px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .payment-method.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .payment-method svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        
        .payment-method span {
            display: block;
            font-size: 11px;
            color: #666;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
        }
        
        .nav-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-tab.active {
            background: #2196F3;
            color: white;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>–¢–µ—Ä–º–∏–Ω–∞–ª –º–∞—Å—Ç–µ—Ä–∞</h1>
        <div class="header-status" id="headerStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    
    <div class="container">
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="jobs">–ó–∞–∫–∞–∑—ã</div>
            <div class="nav-tab" data-tab="earnings">–ó–∞—Ä–∞–±–æ—Ç–æ–∫</div>
            <div class="nav-tab" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
        </div>
        
        <div id="jobsTab">
            <div id="activeJob" class="hidden"></div>
            <div id="pendingJobs"></div>
            <div id="emptyState" class="card empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
                <p style="font-size: 13px; margin-top: 8px;">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
            </div>
        </div>
        
        <div id="earningsTab" class="hidden">
            <div class="card">
                <div class="card-title">–ó–∞—Ä–∞–±–æ—Ç–æ–∫ —Å–µ–≥–æ–¥–Ω—è</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="todayEarnings">0 ‚ÇΩ</div>
                        <div class="stat-label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayJobs">0</div>
                        <div class="stat-label">–ó–∞–∫–∞–∑–æ–≤</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">–ò—Å—Ç–æ—Ä–∏—è</div>
                <div id="transactionsList"></div>
            </div>
        </div>
        
        <div id="profileTab" class="hidden">
            <div class="card">
                <div class="card-title">–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</div>
                <div id="profileInfo"></div>
            </div>
            <div class="card">
                <div class="card-title">–°–µ–≥–æ–¥–Ω—è</div>
                <div id="availabilityToday"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:8000/api/v1';
        
        // Get master ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        let masterId = urlParams.get('id') || localStorage.getItem('masterId');
        
        if (!masterId) {
            document.querySelector('.container').innerHTML = `
                <div class="card">
                    <h2 style="margin-bottom: 16px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
                    <p style="margin-bottom: 16px; color: #666;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID –º–∞—Å—Ç–µ—Ä–∞ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª</p>
                    <input type="text" id="masterIdInput" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 16px;">
                    <button class="btn btn-primary" onclick="loginMaster()">–í–æ–π—Ç–∏</button>
                </div>
            `;
        }
        
        function loginMaster() {
            const id = document.getElementById('masterIdInput').value.trim();
            if (id) {
                localStorage.setItem('masterId', id);
                window.location.reload();
            }
        }
        
        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                const tabName = this.dataset.tab;
                document.getElementById('jobsTab').classList.toggle('hidden', tabName !== 'jobs');
                document.getElementById('earningsTab').classList.toggle('hidden', tabName !== 'earnings');
                document.getElementById('profileTab').classList.toggle('hidden', tabName !== 'profile');
                
                if (tabName === 'earnings') loadEarnings();
                if (tabName === 'profile') loadProfile();
            });
        });
        
        async function loadActiveJob() {
            if (!masterId) return;
            
            try {
                const response = await fetch(`${API_URL}/terminal/jobs/${masterId}/active`);
                const data = await response.json();
                
                if (data.has_active_job && data.job) {
                    renderActiveJob(data.job);
                    document.getElementById('emptyState').classList.add('hidden');
                } else {
                    document.getElementById('activeJob').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                }
                
                document.getElementById('headerStatus').textContent = data.has_active_job ? 
                    '–ï—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑' : '–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤';
                    
            } catch (error) {
                console.error('Error loading active job:', error);
            }
        }
        
        function renderActiveJob(job) {
            const container = document.getElementById('activeJob');
            container.classList.remove('hidden');
            
            const categoryNames = {
                'electrical': '‚ö° –≠–ª–µ–∫—Ç—Ä–∏–∫–∞',
                'plumbing': 'üíß –°–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞',
                'appliances': 'üîå –ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞',
                'renovation': 'üé® –†–µ–º–æ–Ω—Ç'
            };
            
            const statusNames = {
                'assigned': '–ù–∞–∑–Ω–∞—á–µ–Ω',
                'accepted': '–ü—Ä–∏–Ω—è—Ç',
                'in_transit': '–í –ø—É—Ç–∏',
                'in_progress': '–í —Ä–∞–±–æ—Ç–µ',
                'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω'
            };
            
            let actionButtons = '';
            
            if (job.status === 'assigned') {
                actionButtons = `
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="acceptJob('${job.id}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                        <button class="btn btn-outline" onclick="rejectJob('${job.id}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                `;
            } else if (job.status === 'accepted') {
                actionButtons = `
                    <button class="btn btn-primary" onclick="updateStatus('${job.id}', 'in_transit')">–í—ã–µ—Ö–∞–ª –∫ –∫–ª–∏–µ–Ω—Ç—É</button>
                `;
            } else if (job.status === 'in_transit') {
                actionButtons = `
                    <button class="btn btn-primary" onclick="updateStatus('${job.id}', 'in_progress')">–ù–∞—á–∞–ª —Ä–∞–±–æ—Ç—É</button>
                `;
            } else if (job.status === 'in_progress') {
                actionButtons = `
                    <button class="btn btn-success" onclick="updateStatus('${job.id}', 'completed')">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É</button>
                `;
            } else if (job.status === 'completed') {
                container.innerHTML = renderPaymentSection(job);
                return;
            }
            
            container.innerHTML = `
                <div class="card job-card ${job.urgency === 'urgent' ? 'urgent' : ''}">
                    <div class="job-header">
                        <div>
                            <span class="status-badge status-${job.status}">${statusNames[job.status]}</span>
                            <div class="job-category" style="margin-top: 8px;">${categoryNames[job.category] || job.category}</div>
                        </div>
                        <div class="job-price">${job.master_earnings?.toFixed(0) || 0} ‚ÇΩ</div>
                    </div>
                    
                    <div class="job-info">
                        <strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${job.client_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                    </div>
                    <div class="job-info">
                        <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <a href="tel:${job.client_phone}">${job.client_phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</a>
                    </div>
                    
                    <div class="job-address">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <div>${job.address}</div>
                    </div>
                    
                    <div class="job-info">
                        <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${job.client_description}
                    </div>
                    
                    ${job.instructions ? `
                        <div class="job-instructions">
                            <div class="job-instructions-title">üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</div>
                            <div style="font-size: 13px;">${JSON.stringify(job.instructions, null, 2)}</div>
                        </div>
                    ` : ''}
                    
                    ${actionButtons}
                </div>
            `;
        }
        
        function renderPaymentSection(job) {
            return `
                <div class="card payment-section">
                    <div class="card-title">–ü—Ä–∏–µ–º –æ–ø–ª–∞—Ç—ã</div>
                    <div class="payment-amount">${job.client_cost?.toFixed(0) || 0} ‚ÇΩ</div>
                    
                    <div class="payment-methods">
                        <div class="payment-method selected" data-method="card" onclick="selectPaymentMethod(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            <span>–ö–∞—Ä—Ç–∞</span>
                        </div>
                        <div class="payment-method" data-method="sbp" onclick="selectPaymentMethod(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                <path d="M2 17l10 5 10-5"></path>
                                <path d="M2 12l10 5 10-5"></path>
                            </svg>
                            <span>–°–ë–ü</span>
                        </div>
                        <div class="payment-method" data-method="cash" onclick="selectPaymentMethod(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            <span>–ù–∞–ª–∏—á–Ω—ã–µ</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="processPayment('${job.id}')">–ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É</button>
                </div>
            `;
        }
        
        let selectedPaymentMethod = 'card';
        
        function selectPaymentMethod(el) {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
            el.classList.add('selected');
            selectedPaymentMethod = el.dataset.method;
        }
        
        async function acceptJob(jobId) {
            try {
                const response = await fetch(`${API_URL}/terminal/jobs/${masterId}/accept/${jobId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadActiveJob();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–∫–∞–∑–∞');
                }
            } catch (error) {
                console.error('Error accepting job:', error);
            }
        }
        
        async function rejectJob(jobId) {
            if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?')) return;
            
            try {
                const response = await fetch(`${API_URL}/terminal/jobs/${masterId}/reject/${jobId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadActiveJob();
                }
            } catch (error) {
                console.error('Error rejecting job:', error);
            }
        }
        
        async function updateStatus(jobId, newStatus) {
            try {
                const response = await fetch(`${API_URL}/terminal/jobs/${masterId}/status/${jobId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({status: newStatus})
                });
                
                if (response.ok) {
                    loadActiveJob();
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }
        
        async function processPayment(jobId) {
            try {
                const response = await fetch(`${API_URL}/terminal/payment/process`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        job_id: jobId,
                        payment_method: selectedPaymentMethod
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (selectedPaymentMethod === 'cash') {
                        alert(`–û–ø–ª–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞! –í–∞—à –∑–∞—Ä–∞–±–æ—Ç–æ–∫: ${data.master_earnings} ‚ÇΩ`);
                    } else {
                        alert('–ü–æ–∫–∞–∂–∏—Ç–µ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç—É –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É');
                    }
                    loadActiveJob();
                }
            } catch (error) {
                console.error('Error processing payment:', error);
            }
        }
        
        async function loadEarnings() {
            try {
                const response = await fetch(`${API_URL}/terminal/earnings/${masterId}`);
                const data = await response.json();
                
                document.getElementById('todayEarnings').textContent = `${data.total_earnings?.toFixed(0) || 0} ‚ÇΩ`;
                document.getElementById('todayJobs').textContent = data.total_transactions || 0;
            } catch (error) {
                console.error('Error loading earnings:', error);
            }
        }
        
        async function loadProfile() {
            try {
                const response = await fetch(`${API_URL}/masters/${masterId}`);
                const data = await response.json();
                
                document.getElementById('profileInfo').innerHTML = `
                    <div class="job-info"><strong>–ò–º—è:</strong> ${data.full_name}</div>
                    <div class="job-info"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${data.phone}</div>
                    <div class="job-info"><strong>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:</strong> ${(data.specializations || []).join(', ')}</div>
                    <div class="job-info"><strong>–†–µ–π—Ç–∏–Ω–≥:</strong> ${data.rating || '–ù–æ–≤—ã–π'}</div>
                    <div class="job-info"><strong>–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤:</strong> ${data.completed_jobs || 0}</div>
                `;
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        // Load data on start
        if (masterId) {
            loadActiveJob();
            setInterval(loadActiveJob, 30000); // Poll every 30 seconds
        }
    </script>
</body>
</html>
